var constants = require('ornstein-constants');
var fs = require('fs');
var notify = require('notify');
var path = require('path');
exports.getRequests = function(projectName) {
    var project = getProjectDefinition(projectName);
    var nodes = project.nodes;
    //notify.info('nodes: ' + nodes.length);
    var requestList = [];
    for (var node in nodes) {
        if (nodes[node].type === 'Request') {
            requestList.push(nodes[node]);
        }
    }
    return requestList;
};
exports.normalize = function(definition) {
    var queries = definition.uri.query ? definition.uri.query.items : [];
    return {
        name:definition.name,
        method: definition.method.name,
        headers: definition.headers,
        url:definition.uri.path,
        query:queries,
        scheme:definition.uri.scheme,
        body:definition.body.textBody
    }
};
var listFiles = function(path) {
    var exists = fs.existsSync(path);
    var list = [];
    if (exists) {
        list = fs.readdirSync(path);
    }
    return list;
};
var listResourceTests = function(projectName) {
    return listFiles(global.appRoot + '/projects' + '/' + projectName + constants.CONST_RESOURCE_TESTS_DIR);
};
var listCommonTests = function(projectName) {
    return listFiles(global.appRoot + '/projects' + '/' + projectName + constants.CONST_COMMON_TESTS_DIR);
};
var testName = function(fileName) {
    return path.basename(fileName, '.js');
};
exports.getTestsForRequest = function(requestName, projectName) {
    var resourceTests = listResourceTests(projectName);
    var commonTests = listCommonTests(projectName);
    var requestTest = resourceTests.reduce(function(previous, name) {
        return (testName(name) === requestName) ? 'resource-tests/' + name : previous;
    }, null);
    commonTests = commonTests.map(function(name) {
        return 'common-tests/' + name;
    });
    if (requestTest) {
        commonTests.push(requestTest);
    }
    //console.log('Tests executed for '+ requestName+' :: '+JSON.stringify(commonTests));
    return commonTests;
};
var getProjectDefinition = function(projectName) {
    var path = constants.CONST_PROJECT_DIR + '/' + projectName + constants.CONST_DHC_DIR + '/' + projectName + '.json';
    //notify.info('looking for project in ' + path);
    return require(path);
};