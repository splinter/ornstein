var path = require('path');
var fs = require('fs');
exports.run = function(resultSet){
	var Handlebars = require('handlebars');
	// var fs = require('fs');
	// var content = fs.readFileSync(global.appRoot+'/templates/report.hbs').toString();
	// var ptr = Handlebars.compile(content);
	// console.log(ptr());
	loadPartials(Handlebars);
	var content = renderPage(Handlebars,"report",resultSet);
	printDocument(content);
	console.log(JSON.stringify(resultSet,null,4));
};


//Load the partials
var loadPartials = function(hb){
	var partialLocation = global.appRoot+'/templates/partials';
	//Get the list of all files in the partials directory
	var files = fs.readdirSync(partialLocation);
	files.forEach(function(file){
		//var content = fs.readFileSync(file);
		//console.log('file: '+file);
		var partialName = path.basename(file,'.hbs');
		console.log('partial : '+partialName);
		var content = fs.readFileSync(global.appRoot+'/templates/partials/'+file).toString();
		hb.registerPartial(partialName,content);
	});
};

var renderPage = function(hb,pageName,context){
	var content = fs.readFileSync(global.appRoot+'/templates/pages/'+pageName+'.hbs').toString();
	var ptr = hb.compile(content);
	return ptr(context);
};

var printDocument = function(content){
	fs.writeFileSync("report.html",content);
};
